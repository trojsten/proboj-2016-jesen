/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package gui;

import java.awt.Color;
import java.awt.Font;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.RenderingHints;
import java.awt.font.FontRenderContext;
import java.awt.font.LineMetrics;
import java.util.ArrayList;

/**
 *
 * @author siegrift
 */
public class Observer extends javax.swing.JPanel {

    /**
     * Creates new form Observer
     */
    int data[][][];
    int N, M;
    int PIXEL_SIZE = 50;
    ArrayList<Color> playerColors;
    int playerHeads[][];
    int alive[];

    public static final int SNAKE_INDEX = 0;
    public static final int AREA_INDEX = 1;
    public static final int TYPE_INDEX = 2;

    final int UNDEFINED = -1;
    final int SNAKE_HEAD = 1000;

    final float AREA_TRANSPARENCY = (float) 0.5;

    final int IS_WALL = 1;
    final int PLAYER_SPAWN = 2;
    final int SPAWN_CELL = 3;
    final int FAST_BONUS = 4;
    final int STONE_BONUS = 5;
    final Color WALL_COLOR = new Color(0, 0, 0, (float) 0.5);
    final Color SPAWN_COLOR = new Color(255, 204, 0);

    final int PLAYER_DEAD = 0;

    int xoffset;
    int yoffset;

    public Observer() {
        initComponents();
    }

    @Override
    protected void paintComponent(Graphics g) {
        super.paintComponent(g); //To change body of generated methods, choose Tools | Templates.
        g.setColor(Color.GRAY);
        g.fillRect(0, 0, getWidth(), getHeight());

        PIXEL_SIZE = Math.min(getHeight() / N, getWidth() / M);
        xoffset = (getWidth() - N * PIXEL_SIZE) / 2;
        yoffset = (getHeight() - M * PIXEL_SIZE) / 2;

        for (int i = 0; i < N; i++) {
            for (int j = 0; j < M; j++) {
                if (data[i][j][TYPE_INDEX] != IS_WALL && data[i][j][SNAKE_INDEX] == UNDEFINED && data[i][j][AREA_INDEX] == UNDEFINED) {
                    g.setColor(Color.WHITE);
                    g.fillRect(xoffset + i * PIXEL_SIZE, yoffset + j * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                }

                if (data[i][j][TYPE_INDEX] == IS_WALL) {
                    g.setColor(WALL_COLOR);
                    g.fillRect(xoffset + i * PIXEL_SIZE, yoffset + j * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                } else if (data[i][j][TYPE_INDEX] == SPAWN_CELL) {
                    setSpawnCell(g, i, j);
                } else if (data[i][j][TYPE_INDEX] == FAST_BONUS) {
                    setSpawnCell(g, i, j);
                    drawString(g, "F", i, j);
                } else if (data[i][j][TYPE_INDEX] == STONE_BONUS) {
                    setSpawnCell(g, i, j);
                    drawString(g, "S", i, j);
                }

                if (data[i][j][SNAKE_INDEX] >= SNAKE_HEAD) {
                    g.setColor(playerColors.get(data[i][j][SNAKE_INDEX] - SNAKE_HEAD));
                    g.fillRect(xoffset + i * PIXEL_SIZE, yoffset + j * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                    drawString(g, "H", i, j);
                } else if (data[i][j][SNAKE_INDEX] != UNDEFINED) {
                    g.setColor(playerColors.get(data[i][j][SNAKE_INDEX]));
                    g.fillRect(xoffset + i * PIXEL_SIZE, yoffset + j * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                }

                if (data[i][j][AREA_INDEX] != UNDEFINED) {
                    Color c = playerColors.get(data[i][j][AREA_INDEX]);
                    g.setColor(new Color(c.getRed(), c.getGreen(), c.getBlue(), (int) (AREA_TRANSPARENCY * 255)));
                    g.fillRect(xoffset + i * PIXEL_SIZE, yoffset + j * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                }
            }
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 400, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 300, Short.MAX_VALUE)
        );
    }// </editor-fold>//GEN-END:initComponents

    synchronized void setData(int[][][] dat, int[][] heads, int[] live) {
        data = dat.clone();
        playerHeads = heads.clone();
        alive = live.clone();
        for (int i = 0; i < playerHeads.length; i++) {
            int x = playerHeads[i][0], y = playerHeads[i][1];
            if (x < 0 || y < 0 || x >= N || y >= M || alive[i] == PLAYER_DEAD) {
                continue;
            }
            data[x][y][SNAKE_INDEX] = SNAKE_HEAD + i;
        }
    }

    void initData(ArrayList<Color> cols, int n, int m) {
        playerColors = cols;
        data = new int[n][m][3];
        N = n;
        M = m;
    }

    private void setSpawnCell(Graphics g, int i, int j) {
        g.setColor(SPAWN_COLOR);
        g.fillRect(xoffset + i * PIXEL_SIZE, yoffset + j * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    }

    private void drawString(Graphics g, String mess, int i, int j) {
        g.setColor(Color.BLACK);
        int sz, w = 0, h = 0;
        Graphics2D g2 = (Graphics2D) g;
        g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
        g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING, RenderingHints.VALUE_TEXT_ANTIALIAS_ON);

        for (sz = 0; sz < 100; sz++) {
            FontRenderContext frc = g2.getFontRenderContext();
            Font font = new Font("Noto Sans", Font.BOLD, sz);
            w = (int) font.getStringBounds(mess, frc).getWidth();
            LineMetrics lm = font.getLineMetrics(mess, frc);
            h = (int) lm.getAscent();
            if (w >= PIXEL_SIZE || h >= PIXEL_SIZE) {
                break;
            }
        }
        g.setFont(new Font("Noto Sans", Font.BOLD, sz));
        g.drawString(mess, xoffset + (PIXEL_SIZE - w) / 2 + i * PIXEL_SIZE, yoffset + (j + 1) * PIXEL_SIZE);
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    // End of variables declaration//GEN-END:variables
}
